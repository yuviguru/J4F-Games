<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="theme-color" content="#1a0a2e">
<title>Raaja Raani â€” J4F</title>
<link rel="manifest" href="/manifest.json">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(180deg,#1a0a2e,#0d0518);color:#d4c4f0;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
#app{height:100dvh;overflow-y:auto;overflow-x:hidden;display:flex;flex-direction:column;align-items:center;padding:16px 12px 100px}

/* Shared */
.title{color:#ffd700;font-size:28px;font-weight:900;letter-spacing:2px;text-shadow:0 2px 12px rgba(255,215,0,.3)}
.subtitle{color:#9080b0;font-size:12px;letter-spacing:3px;text-transform:uppercase}
.btn{padding:10px 18px;background:rgba(60,20,80,.6);color:#d4c4f0;border:1px solid #6b3a8a;border-radius:12px;font:600 13px -apple-system,sans-serif;cursor:pointer;-webkit-tap-highlight-color:transparent;transition:transform .1s}
.btn:active{transform:scale(.96)}
.btn-primary{padding:12px 24px;background:linear-gradient(135deg,#b8860b,#daa520);color:#1a0a2e;border:none;border-radius:12px;font:700 15px -apple-system,sans-serif;cursor:pointer;box-shadow:0 4px 16px rgba(218,165,32,.4);transition:transform .1s}
.btn-primary:active{transform:scale(.96)}
.btn-wa{padding:12px 20px;background:linear-gradient(135deg,#1a5c2e,#0f3d1e);color:#4ade80;border:2px solid #2a8c4a;border-radius:12px;font:700 14px -apple-system,sans-serif;cursor:pointer;display:flex;align-items:center;gap:8px;justify-content:center;width:100%}
.btn-copy{padding:12px 20px;background:linear-gradient(135deg,#2a1a4a,#1a0e30);color:#b39ddb;border:2px solid #6b45a0;border-radius:12px;font:700 14px -apple-system,sans-serif;cursor:pointer;display:flex;align-items:center;gap:8px;justify-content:center;width:100%}
.card{background:linear-gradient(145deg,#2a1545,#1e0f35);border:2px solid #4a2a6a;border-radius:14px;padding:14px 16px;display:flex;align-items:center;gap:14px;cursor:pointer;text-align:left;width:100%;transition:transform .1s}
.card:active{transform:scale(.98)}
.error-box{color:#ff6b6b;font-size:12px;font-weight:600;background:rgba(255,50,50,.15);padding:8px 14px;border-radius:8px;border:1px solid rgba(255,50,50,.3);text-align:center;width:100%}
.screen{width:100%;max-width:400px;display:flex;flex-direction:column;align-items:center;gap:12px}

/* Role cards */
.role-card{width:90px;height:130px;border-radius:14px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;font-weight:700;font-size:12px;box-shadow:0 4px 16px rgba(0,0,0,.4);transition:all .3s ease;cursor:pointer;border:3px solid transparent;position:relative}
.role-card.face-down{background:linear-gradient(135deg,#3a1a5a,#2a1040);border-color:#5a3a7a;cursor:default}
.role-card.face-down::after{content:"?";font-size:36px;color:#6a4a8a}
.role-card .role-emoji{font-size:36px}
.role-card .role-name{font-size:11px;letter-spacing:1px}
.role-card .role-tamil{font-size:9px;opacity:.7}
.role-card.raja{background:linear-gradient(135deg,#ffd700,#b8860b);color:#1a0a2e;border-color:#ffd700}
.role-card.rani{background:linear-gradient(135deg,#ff69b4,#c44488);color:#fff;border-color:#ff69b4}
.role-card.sipahi{background:linear-gradient(135deg,#4488ff,#2255cc);color:#fff;border-color:#4488ff}
.role-card.chor{background:linear-gradient(135deg,#555,#333);color:#fff;border-color:#888}

/* Player slots */
.players-row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;width:100%}
.player-slot{display:flex;flex-direction:column;align-items:center;gap:6px;padding:8px;border-radius:12px;background:rgba(255,255,255,.04);border:2px solid transparent;min-width:85px;transition:all .3s}
.player-slot.active{border-color:#ffd700;background:rgba(255,215,0,.08)}
.player-slot.highlight{border-color:#ff69b4;background:rgba(255,105,180,.08);animation:glowPink 1s ease infinite}
.player-name{font-size:12px;font-weight:700;max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.player-score{font-size:11px;color:#9080b0}
.player-badge{font-size:9px;padding:2px 6px;border-radius:6px;font-weight:700;letter-spacing:.5px}

/* Scoreboard */
.scoreboard{width:100%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:6px}
.score-row{display:flex;align-items:center;gap:10px;padding:6px 8px;border-radius:8px}
.score-row.leader{background:rgba(255,215,0,.1);border:1px solid rgba(255,215,0,.2)}
.score-rank{width:20px;font-weight:800;font-size:14px;text-align:center}
.score-name{flex:1;font-weight:600;font-size:13px}
.score-pts{font-weight:800;color:#ffd700;font-size:14px}

/* Round display */
.round-badge{background:rgba(255,215,0,.15);border:1px solid rgba(255,215,0,.3);border-radius:20px;padding:4px 14px;font-size:11px;color:#ffd700;font-weight:700;letter-spacing:1px}

/* Online lobby */
.room-code-display{background:rgba(0,0,0,.4);border:3px solid #ffd700;border-radius:16px;padding:24px 36px;text-align:center}
.room-code-text{color:#ffd700;font-size:48px;font-weight:800;letter-spacing:12px;text-shadow:0 2px 12px rgba(255,215,0,.4)}
.join-input{width:100%;max-width:160px;padding:12px;font:800 24px -apple-system,sans-serif;text-align:center;letter-spacing:8px;background:rgba(0,0,0,.3);color:#ffd700;border:2px solid #4a2a6a;border-radius:10px;outline:none;text-transform:uppercase}
.share-row{display:flex;gap:8px;width:100%;max-width:320px}

/* Guess overlay */
.guess-prompt{background:rgba(0,0,0,.85);border:2px solid #4488ff;border-radius:16px;padding:20px;text-align:center;width:100%}

/* Result overlay */
.result-display{background:rgba(0,0,0,.6);border:2px solid #ffd700;border-radius:16px;padding:20px;text-align:center;width:100%;animation:fadeUp .4s ease}

/* Animations */
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes flipIn{0%{transform:rotateY(90deg);opacity:0}100%{transform:rotateY(0);opacity:1}}
@keyframes glowGold{0%,100%{box-shadow:0 0 8px rgba(255,215,0,.3)}50%{box-shadow:0 0 20px rgba(255,215,0,.6)}}
@keyframes glowPink{0%,100%{box-shadow:0 0 8px rgba(255,105,180,.2)}50%{box-shadow:0 0 16px rgba(255,105,180,.5)}}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}
@keyframes bounceIn{0%{transform:scale(0);opacity:0}50%{transform:scale(1.15)}100%{transform:scale(1);opacity:1}}
@keyframes slideDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:.6}50%{opacity:1}}
@keyframes dotBlink{0%,20%{opacity:0}50%{opacity:1}100%{opacity:0}}
@keyframes cardDeal{0%{transform:scale(0) rotate(-20deg);opacity:0}60%{transform:scale(1.1) rotate(5deg);opacity:1}100%{transform:scale(1) rotate(0)}}
.anim-fadeUp{animation:fadeUp .4s ease both}
.anim-flipIn{animation:flipIn .4s ease both}
.anim-bounce{animation:bounceIn .5s ease both}
.anim-pulse{animation:pulse 1.5s ease infinite}
.anim-deal{animation:cardDeal .4s ease both}
</style>
</head>
<body>
<div id="app"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
<script src="/js/firebase-config.js"></script>
<script src="/js/j4f-sdk.js"></script>

<script>
/* â•â•â•â•â•â•â• CONFIG â•â•â•â•â•â•â• */
const ROLES = [
  {id:"raja",  name:"Raja",   tamil:"à®°à®¾à®œà®¾",    emoji:"ğŸ‘‘", points:1000, color:"#ffd700", desc:"The King â€” always scores"},
  {id:"rani",  name:"Rani",   tamil:"à®°à®¾à®£à®¿",    emoji:"ğŸ‘¸", points:500,  color:"#ff69b4", desc:"The Queen â€” always scores"},
  {id:"sipahi",name:"Sipahi", tamil:"à®šà®¿à®ªà¯à®ªà®¾à®¯à¯", emoji:"ğŸ‘®", points:800,  color:"#4488ff", desc:"The Police â€” scores if catches Chor"},
  {id:"chor",  name:"Chor",   tamil:"à®šà¯‹à®°à¯",    emoji:"ğŸ¦¹", points:800,  color:"#888",    desc:"The Thief â€” scores if escapes"},
];
const TOTAL_ROUNDS = 10;
const PLAYER_NAMES = ["You", "Ajay", "Priya", "Kumar"];
const PLAYER_EMOJIS = ["ğŸ™‚", "ğŸ˜", "ğŸŒ¸", "ğŸ¯"];

/* â•â•â•â•â•â•â• STATE â•â•â•â•â•â•â• */
const S = {
  screen: "menu",
  gameMode: null, // "ai" | "local" | "online"
  // Players: [{name, emoji, score, role, isHuman}]
  players: [],
  round: 0,
  phase: "deal", // "deal" | "raja-reveal" | "sipahi-guess" | "result" | "game-over"
  roles: [],         // shuffled role indices for this round [0,1,2,3]
  rajaPlayer: -1,    // which player is Raja
  sipahiPlayer: -1,  // which player is Sipahi
  chorPlayer: -1,    // which player is Chor
  raniPlayer: -1,    // which player is Rani
  sipahiGuess: -1,   // who Sipahi guessed
  guessCorrect: false,
  roundScores: [0,0,0,0],
  revealedRoles: [false,false,false,false],
  showAllRoles: false,
  anim: false,
  // online
  roomCode: "", joinCode: "", myPlayer: 0, isOnline: false, opJoined: false, onlineErr: "",
  playersJoined: 0, inviteMsg: "",
  // matchmaking
  searching: false, searchMsg: "",
};
let ac = null, cancelMatchmake = null, seenMoveId = 0;

function ea(){if(!ac)ac=new(window.AudioContext||window.webkitAudioContext)();if(ac.state==="suspended")ac.resume();return ac;}

/* â•â•â•â•â•â•â• AUDIO â•â•â•â•â•â•â• */
function playSound(freq, dur, type="sine", vol=.15){
  const a=ea(),n=a.currentTime;
  const o=a.createOscillator(),g=a.createGain();
  o.type=type;o.frequency.setValueAtTime(freq,n);
  g.gain.setValueAtTime(vol,n);g.gain.exponentialRampToValueAtTime(.001,n+dur);
  o.connect(g);g.connect(a.destination);o.start(n);o.stop(n+dur+.01);
}
function playDeal(){playSound(800,.08,"sine",.1);setTimeout(()=>playSound(1000,.06,"sine",.08),80)}
function playReveal(){playSound(600,.15,"sine",.12);setTimeout(()=>playSound(900,.12,"sine",.1),100)}
function playCorrect(){[0,.08,.16].forEach((d,i)=>setTimeout(()=>playSound(500+i*200,.12,"sine",.12),d*1000))}
function playWrong(){playSound(200,.25,"sawtooth",.1)}
function playWin(){[0,.1,.2,.3].forEach((d,i)=>setTimeout(()=>playSound(400+i*150,.15,"sine",.12),d*1000))}

/* â•â•â•â•â•â•â• GAME LOGIC â•â•â•â•â•â•â• */
function shuffle(arr){const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}

function initPlayers(mode){
  if(mode==="ai"){
    return [
      {name:PLAYER_NAMES[0],emoji:PLAYER_EMOJIS[0],score:0,role:null,isHuman:true},
      {name:PLAYER_NAMES[1],emoji:PLAYER_EMOJIS[1],score:0,role:null,isHuman:false},
      {name:PLAYER_NAMES[2],emoji:PLAYER_EMOJIS[2],score:0,role:null,isHuman:false},
      {name:PLAYER_NAMES[3],emoji:PLAYER_EMOJIS[3],score:0,role:null,isHuman:false},
    ];
  }
  // local
  return [
    {name:"Player 1",emoji:"ğŸ”´",score:0,role:null,isHuman:true},
    {name:"Player 2",emoji:"ğŸ”µ",score:0,role:null,isHuman:true},
    {name:"Player 3",emoji:"ğŸŸ¢",score:0,role:null,isHuman:true},
    {name:"Player 4",emoji:"ğŸŸ¡",score:0,role:null,isHuman:true},
  ];
}

function dealRound(){
  S.round++;
  const order = shuffle([0,1,2,3]); // shuffle role indices
  S.roles = order;
  S.revealedRoles = [false,false,false,false];
  S.showAllRoles = false;
  S.sipahiGuess = -1;
  S.guessCorrect = false;
  S.roundScores = [0,0,0,0];
  // Assign roles
  for(let i=0;i<4;i++){
    S.players[i].role = ROLES[order[i]];
    if(order[i]===0) S.rajaPlayer = i;
    if(order[i]===1) S.raniPlayer = i;
    if(order[i]===2) S.sipahiPlayer = i;
    if(order[i]===3) S.chorPlayer = i;
  }
  S.phase = "deal";
  playDeal();
}

function revealRaja(){
  S.revealedRoles[S.rajaPlayer] = true;
  S.phase = "sipahi-guess";
  playReveal();
}

function sipahiGuess(guessedPlayer){
  if(S.anim) return;
  S.anim = true;
  S.sipahiGuess = guessedPlayer;
  S.guessCorrect = (guessedPlayer === S.chorPlayer);
  // Calculate scores for this round
  S.roundScores = [0,0,0,0];
  S.roundScores[S.rajaPlayer] = 1000; // Raja always gets 1000
  S.roundScores[S.raniPlayer] = 500;  // Rani always gets 500
  if(S.guessCorrect){
    S.roundScores[S.sipahiPlayer] = 800; // Sipahi catches Chor
    S.roundScores[S.chorPlayer] = 0;
    playCorrect();
  } else {
    S.roundScores[S.sipahiPlayer] = 0;
    S.roundScores[S.chorPlayer] = 800;   // Chor escapes
    playWrong();
  }
  // Add to totals
  for(let i=0;i<4;i++) S.players[i].score += S.roundScores[i];
  // Reveal all
  S.showAllRoles = true;
  S.revealedRoles = [true,true,true,true];
  S.phase = "result";

  // Submit to leaderboard if this was the last round
  if(S.round >= TOTAL_ROUNDS){
    setTimeout(()=>{
      S.phase = "game-over";
      playWin();
      // Submit result for AI mode
      if(S.gameMode === "ai"){
        const sorted = [...S.players].sort((a,b)=>b.score-a.score);
        const r = sorted[0].isHuman ? "win" : "loss";
        J4F.leaderboard.submit("raaja-raani", r).catch(()=>{});
      }
      S.anim = false;
      render();
    }, 2500);
  } else {
    setTimeout(()=>{ S.anim = false; render(); }, 300);
  }
  render();
}

function aiSipahiGuess(){
  // AI Sipahi must guess among the 2 unknown players (not Raja, not self)
  const candidates = [];
  for(let i=0;i<4;i++){
    if(i !== S.rajaPlayer && i !== S.sipahiPlayer) candidates.push(i);
  }
  // Random guess (50/50)
  return candidates[Math.floor(Math.random()*candidates.length)];
}

function nextRound(){
  dealRound();
  render();
  // Auto-advance through deal and raja-reveal for AI mode
  if(S.gameMode === "ai"){
    setTimeout(()=>{
      revealRaja();
      render();
      // If AI is Sipahi, auto-guess after a delay
      if(!S.players[S.sipahiPlayer].isHuman){
        setTimeout(()=>{
          const guess = aiSipahiGuess();
          sipahiGuess(guess);
        }, 1200);
      }
    }, 1000);
  }
}

function startGame(mode){
  S.gameMode = mode;
  S.players = initPlayers(mode);
  S.round = 0;
  S.screen = "game";
  nextRound();
}

/* â•â•â•â•â•â•â• ONLINE â•â•â•â•â•â•â• */
async function createRoom(){
  S.onlineErr = "";
  try {
    const initState = {players:[], round:0, phase:"waiting", totalRounds:TOTAL_ROUNDS};
    const {code} = await J4F.room.create("raaja-raani", initState);
    S.roomCode = code; S.myPlayer = 0; S.isOnline = true; S.playersJoined = 1;
    S.screen = "lobby"; render();
    setupOnlineListener();
  } catch(e){ S.onlineErr = "Failed: "+(e.message||e); render(); }
}

async function joinRoom(codeOverride){
  S.onlineErr = "";
  const code = (codeOverride||S.joinCode).toUpperCase().trim();
  if(code.length!==4){S.onlineErr="Enter a 4-letter code";render();return}
  try {
    const {roomData} = await J4F.room.join(code);
    S.roomCode = code; S.myPlayer = 1; S.isOnline = true;
    S.screen = "lobby"; render();
    setupOnlineListener();
  } catch(e){ S.onlineErr = e.message||"Failed to join"; render(); }
}

function setupOnlineListener(){
  J4F.room.onUpdate(data => {
    // Handle online game state updates
    if(data.state && data.state.phase === "playing" && S.screen === "lobby"){
      S.screen = "game";
    }
    render();
  });
}

function shareWA(code){
  const base = window.location.origin+"/games/raaja-raani/";
  const url = code ? base+"?room="+code : base;
  const text = code
    ? "ğŸ‘‘ Join my Raaja Raani game on J4F!\n\nTap to play: "+url
    : "ğŸ‘‘ Let's play Raaja Raani on J4F!\n\nPlay here: "+url;
  J4F.share.whatsapp(text);
}
async function shareCopy(code){
  const base = window.location.origin+"/games/raaja-raani/";
  const url = code ? base+"?room="+code : base;
  const text = code ? "Join my Raaja Raani game!\n\nTap to play: "+url : "Let's play Raaja Raani!\n\nPlay here: "+url;
  const ok = await J4F.share.copy(text);
  S.inviteMsg = ok ? "Copied!" : "Couldn't copy"; render();
  setTimeout(()=>{ S.inviteMsg=""; render(); }, 2000);
}

/* â•â•â•â•â•â•â• RESET â•â•â•â•â•â•â• */
function resetGame(){
  if(cancelMatchmake){cancelMatchmake();cancelMatchmake=null}
  Object.assign(S,{
    screen:"menu",gameMode:null,players:[],round:0,
    phase:"deal",roles:[],rajaPlayer:-1,sipahiPlayer:-1,chorPlayer:-1,raniPlayer:-1,
    sipahiGuess:-1,guessCorrect:false,roundScores:[0,0,0,0],
    revealedRoles:[false,false,false,false],showAllRoles:false,anim:false,
    roomCode:"",joinCode:"",myPlayer:0,isOnline:false,opJoined:false,onlineErr:"",
    playersJoined:0,inviteMsg:"",searching:false,searchMsg:"",
  });
  seenMoveId = 0;
}

/* â•â•â•â•â•â•â• UTILS â•â•â•â•â•â•â• */
const delay = ms => new Promise(r=>setTimeout(r,ms));
const app = document.getElementById("app");

/* â•â•â•â•â•â•â• RENDER â•â•â•â•â•â•â• */
function render(){
  if(S.screen==="menu") renderMenu();
  else if(S.screen==="online") renderOnline();
  else if(S.screen==="lobby") renderLobby();
  else if(S.screen==="game") renderGameScreen();
}

function renderMenu(){
  let h = `<div class="screen" style="padding-top:24px">
    <div class="title">ğŸ‘‘ à®°à®¾à®œà®¾ à®°à®¾à®£à®¿</div>
    <div class="subtitle" style="margin-bottom:2px">Raaja Raani</div>
    <a href="/" style="color:#4d96ff;font-size:11px;text-decoration:none;margin-bottom:8px">â† J4F Home</a>

    <p style="font-size:13px;color:#b0a0c8;text-align:center;line-height:1.4;max-width:320px">
      The classic Indian card role game! 4 players, 4 roles â€” can the Sipahi catch the Chor?
    </p>

    <div class="card anim-fadeUp" onclick="startGame('ai')">
      <div style="font-size:32px">ğŸ¤–</div>
      <div style="flex:1">
        <div style="color:#ffd700;font-weight:700;font-size:16px">Play vs AI</div>
        <div style="color:#9080b0;font-size:12px">You + 3 AI opponents Â· ${TOTAL_ROUNDS} rounds</div>
      </div>
    </div>

    <div class="card anim-fadeUp" style="animation-delay:.08s" onclick="startGame('local')">
      <div style="font-size:32px">ğŸ‘¥</div>
      <div style="flex:1">
        <div style="color:#ffd700;font-weight:700;font-size:16px">Local 4 Players</div>
        <div style="color:#9080b0;font-size:12px">Pass & play on same device</div>
      </div>
    </div>

    <div class="card anim-fadeUp" style="animation-delay:.16s;opacity:.4;pointer-events:none">
      <div style="font-size:32px">ğŸŒ</div>
      <div style="flex:1">
        <div style="color:#5bc0de;font-weight:700;font-size:16px">Online Multiplayer</div>
        <div style="color:#7ab8d4;font-size:12px">Coming soon!</div>
      </div>
    </div>

    <!-- Rules -->
    <div style="margin-top:8px;width:100%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px 16px">
      <p style="font-weight:700;color:#ffd700;margin-bottom:8px;font-size:14px">How to Play</p>
      <div style="font-size:12px;line-height:1.6;color:#b0a0c8">
        <p style="margin-bottom:6px">ğŸƒ Four chits are dealt: <span style="color:#ffd700">Raja</span>, <span style="color:#ff69b4">Rani</span>, <span style="color:#4488ff">Sipahi</span>, and <span style="color:#888">Chor</span>.</p>
        <p style="margin-bottom:6px">ğŸ‘‘ The <strong style="color:#ffd700">Raja</strong> reveals first â€” "I am the Raja!"</p>
        <p style="margin-bottom:6px">ğŸ‘® The <strong style="color:#4488ff">Sipahi</strong> must guess who is the <strong style="color:#888">Chor</strong> among the remaining two.</p>
        <p style="margin-bottom:6px">âœ… If correct: Sipahi gets <strong>800 pts</strong>, Chor gets <strong>0</strong></p>
        <p style="margin-bottom:6px">âŒ If wrong: Chor <em>escapes</em> with <strong>800 pts</strong>, Sipahi gets <strong>0</strong></p>
        <p>ğŸ‘‘ Raja always gets <strong>1000</strong> Â· ğŸ‘¸ Rani always gets <strong>500</strong></p>
      </div>
    </div>

    <div style="font-size:11px;color:#6a5a8a;margin-top:8px">
      ğŸ“¤ <span style="cursor:pointer;color:#4d96ff" onclick="shareWA()">Share with friends</span>
    </div>
  </div>`;
  app.innerHTML = h;
}

function renderOnline(){
  let h = `<div class="screen" style="padding-top:24px;justify-content:center">
    <div class="title" style="font-size:24px">ğŸ‘‘ à®°à®¾à®œà®¾ à®°à®¾à®£à®¿</div>
    <p style="color:#5bc0de;font-size:15px;font-weight:600">ğŸŒ Online Play</p>

    <button class="card" style="background:linear-gradient(145deg,#1a4a2a,#0f3018);border-color:#2a8c4a" onclick="createRoom()">
      <div style="font-size:28px">ğŸ‘«</div>
      <div style="flex:1"><div style="color:#4ade80;font-weight:700;font-size:15px">Create Room</div><div style="color:#6bcb77;font-size:11px">Share code with friends</div></div>
    </button>

    <div style="color:#4a2a6a;font-size:11px;letter-spacing:2px;margin:4px 0">â”€â”€ HAVE A CODE? â”€â”€</div>

    <div style="width:100%;background:linear-gradient(135deg,#2a1a4a,#1a0e30);border:2px solid #4a2a6a;border-radius:14px;padding:14px;text-align:center;display:flex;align-items:center;gap:10px;justify-content:center">
      <div style="font-size:20px">ğŸ®</div>
      <input class="join-input" type="text" maxlength="4" placeholder="ABCD" style="max-width:120px;padding:8px;font-size:20px" value="${S.joinCode}" oninput="S.joinCode=this.value.toUpperCase();S.onlineErr=''">
      <button class="btn-primary" onclick="joinRoom()">Join</button>
    </div>

    ${S.onlineErr?`<div class="error-box">${S.onlineErr}</div>`:""}
    <button class="btn" onclick="S.screen='menu';render()">â† Back</button>
  </div>`;
  app.innerHTML = h;
}

function renderLobby(){
  let h = `<div class="screen" style="padding-top:24px;align-items:center">
    <div class="title" style="font-size:24px">ğŸ‘‘ à®°à®¾à®œà®¾ à®°à®¾à®£à®¿</div>
    <p style="color:#5bc0de;font-size:14px;font-weight:600">ğŸŒ Room Created!</p>
    <div class="room-code-display">
      <div style="color:#9080b0;font-size:11px;letter-spacing:2px;margin-bottom:6px">ROOM CODE</div>
      <div class="room-code-text">${S.roomCode}</div>
    </div>
    <div style="color:#d4c4f0;font-size:13px;margin:4px 0">Waiting for 3 more players...</div>
    <div class="anim-pulse" style="color:#5bc0de;font-size:14px">
      ${S.playersJoined}/4 joined<span style="display:inline-flex;gap:2px">
        <span style="animation:dotBlink 1.4s ease infinite">.</span>
        <span style="animation:dotBlink 1.4s ease infinite .2s">.</span>
        <span style="animation:dotBlink 1.4s ease infinite .4s">.</span>
      </span>
    </div>
    <div class="share-row" style="margin-top:12px">
      <button class="btn-wa" style="flex:1;padding:10px;font-size:12px" onclick="shareWA('${S.roomCode}')">ğŸ’¬ WhatsApp</button>
      <button class="btn-copy" style="flex:1;padding:10px;font-size:12px" onclick="shareCopy('${S.roomCode}')">ğŸ“‹ Copy${S.inviteMsg?" âœ“":""}</button>
    </div>
    <button class="btn" style="margin-top:12px" onclick="resetGame();render()">Cancel</button>
  </div>`;
  app.innerHTML = h;
}

function renderGameScreen(){
  if(S.phase === "game-over") return renderGameOver();

  const isLocal = S.gameMode === "local";
  const isAI = S.gameMode === "ai";

  // Sorted scoreboard for rankings
  const ranked = S.players.map((p,i)=>({...p,idx:i})).sort((a,b)=>b.score-a.score);

  // Determine what to show based on phase
  let phaseHTML = "";

  if(S.phase === "deal"){
    // Show dealt cards face-down, with player's own card revealed (AI mode) or pass-to-see (local)
    phaseHTML = renderDealPhase(isLocal, isAI);
  } else if(S.phase === "sipahi-guess"){
    phaseHTML = renderGuessPhase(isLocal, isAI);
  } else if(S.phase === "result"){
    phaseHTML = renderResultPhase();
  }

  let h = `<div class="screen">
    <!-- Header -->
    <div style="display:flex;align-items:center;justify-content:space-between;width:100%">
      <div>
        <div class="title" style="font-size:22px;letter-spacing:1px">ğŸ‘‘ à®°à®¾à®œà®¾ à®°à®¾à®£à®¿</div>
        <div style="color:#9080b0;font-size:10px;letter-spacing:1.5px">${isAI?"vs AI":"Local"} Â· Round ${S.round}/${TOTAL_ROUNDS}</div>
      </div>
      <div class="round-badge">Round ${S.round}/${TOTAL_ROUNDS}</div>
    </div>

    <!-- Scoreboard mini -->
    <div style="display:flex;gap:6px;width:100%;flex-wrap:wrap;justify-content:center">
      ${S.players.map((p,i)=>`
        <div style="flex:1;min-width:80px;text-align:center;padding:6px;border-radius:10px;background:rgba(255,255,255,.04);border:1px solid ${ranked[0].idx===i&&S.round>1?"rgba(255,215,0,.3)":"rgba(255,255,255,.06)"}">
          <div style="font-size:18px">${p.emoji}</div>
          <div style="font-size:10px;font-weight:700;margin-top:2px">${p.name}</div>
          <div style="font-size:13px;font-weight:800;color:#ffd700">${p.score}</div>
        </div>
      `).join("")}
    </div>

    <!-- Phase content -->
    ${phaseHTML}

    <!-- Footer buttons -->
    <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;justify-content:center">
      <button class="btn" onclick="resetGame();render()">â† Menu</button>
    </div>
  </div>`;

  app.innerHTML = h;
}

function renderDealPhase(isLocal, isAI){
  // Show the cards being dealt
  let h = `<div style="text-align:center;width:100%;animation:slideDown .4s ease">
    <p style="font-size:14px;font-weight:700;color:#ffd700;margin-bottom:6px">ğŸƒ Chits Dealt!</p>
    <p style="font-size:12px;color:#9080b0;margin-bottom:12px">Each player has received a secret role</p>

    <div class="players-row">
      ${S.players.map((p,i)=>{
        const showRole = isAI ? (i === 0) : false; // In AI mode, show player 0's role
        const role = p.role;
        return `<div class="player-slot anim-deal" style="animation-delay:${i*.12}s">
          <div style="font-size:22px">${p.emoji}</div>
          <div class="player-name">${p.name}</div>
          ${showRole
            ? `<div class="role-card ${role.id}" style="width:70px;height:100px">
                <div class="role-emoji">${role.emoji}</div>
                <div class="role-name">${role.name}</div>
                <div class="role-tamil">${role.tamil}</div>
              </div>`
            : `<div class="role-card face-down" style="width:70px;height:100px"></div>`
          }
        </div>`;
      }).join("")}
    </div>`;

  if(isAI){
    h += `<p style="font-size:13px;margin-top:12px;color:#d4c4f0">Your role: <strong style="color:${S.players[0].role.color}">${S.players[0].role.emoji} ${S.players[0].role.name}</strong></p>
    <button class="btn-primary" style="margin-top:12px" onclick="revealRaja();render()">
      ${S.rajaPlayer===0 ? "ğŸ‘‘ I am the Raja!" : "Continue â†’"}
    </button>`;
  } else {
    // Local: pass device prompt
    h += `<p style="font-size:13px;margin-top:12px;color:#ff69b4">Pass the device to each player to see their role!</p>
    <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px">
      ${S.players.map((p,i)=>`
        <button class="btn" onclick="alert('${p.name}, your role is: ${p.role.emoji} ${p.role.name} (${p.role.tamil})');${i===3?"revealRaja();render()":""}">
          ${p.emoji} Peek
        </button>
      `).join("")}
    </div>
    <button class="btn-primary" style="margin-top:12px" onclick="revealRaja();render()">Everyone ready â†’ Reveal Raja</button>`;
  }

  h += `</div>`;
  return h;
}

function renderGuessPhase(isLocal, isAI){
  // Raja has been revealed, Sipahi must guess
  const raja = S.players[S.rajaPlayer];
  const sipahi = S.players[S.sipahiPlayer];
  const isSipahiHuman = sipahi.isHuman;

  // Candidates: not Raja, not Sipahi
  const candidates = [];
  for(let i=0;i<4;i++){
    if(i !== S.rajaPlayer && i !== S.sipahiPlayer) candidates.push(i);
  }

  let h = `<div style="text-align:center;width:100%;animation:fadeUp .4s ease">
    <!-- Raja revealed -->
    <div style="margin-bottom:12px">
      <p style="font-size:12px;color:#9080b0;margin-bottom:6px">The Raja has been revealed!</p>
      <div style="display:inline-flex;align-items:center;gap:8px;background:rgba(255,215,0,.1);border:2px solid rgba(255,215,0,.3);border-radius:12px;padding:8px 16px;animation:glowGold 1.5s ease infinite">
        <span style="font-size:28px">ğŸ‘‘</span>
        <div>
          <div style="font-size:16px;font-weight:800;color:#ffd700">${raja.emoji} ${raja.name}</div>
          <div style="font-size:10px;color:#b0a040">is the Raja!</div>
        </div>
      </div>
    </div>

    <!-- Sipahi revealed -->
    <div style="margin-bottom:12px">
      <div style="display:inline-flex;align-items:center;gap:8px;background:rgba(68,136,255,.1);border:2px solid rgba(68,136,255,.3);border-radius:12px;padding:8px 16px">
        <span style="font-size:28px">ğŸ‘®</span>
        <div>
          <div style="font-size:16px;font-weight:800;color:#4488ff">${sipahi.emoji} ${sipahi.name}</div>
          <div style="font-size:10px;color:#7aadff">is the Sipahi! Must find the Chor!</div>
        </div>
      </div>
    </div>

    <!-- Guess prompt -->
    <div class="guess-prompt">
      <p style="font-size:15px;font-weight:700;color:#4488ff;margin-bottom:8px">
        ğŸ‘® ${sipahi.name}, who is the Chor?
      </p>
      <p style="font-size:11px;color:#9080b0;margin-bottom:12px">Choose one of these two players:</p>
      <div style="display:flex;gap:12px;justify-content:center">
        ${candidates.map(ci=>{
          const c = S.players[ci];
          return `<div class="player-slot highlight" style="cursor:pointer;min-width:100px" onclick="sipahiGuess(${ci})">
            <div style="font-size:30px">${c.emoji}</div>
            <div class="player-name" style="font-size:14px">${c.name}</div>
            <div class="role-card face-down" style="width:60px;height:80px;font-size:11px"></div>
            <div style="font-size:10px;color:#ff69b4">Tap to accuse!</div>
          </div>`;
        }).join("")}
      </div>
    </div>
  </div>`;
  return h;
}

function renderResultPhase(){
  const sipahi = S.players[S.sipahiPlayer];
  const chor = S.players[S.chorPlayer];
  const guessed = S.players[S.sipahiGuess];
  const correct = S.guessCorrect;

  let h = `<div style="text-align:center;width:100%;animation:fadeUp .4s ease">
    <!-- Guess result -->
    <div class="result-display" style="border-color:${correct?"#4ade80":"#ff6b6b"}">
      <div style="font-size:48px;margin-bottom:8px;animation:bounceIn .5s ease">${correct?"âœ…":"âŒ"}</div>
      <p style="font-size:18px;font-weight:800;color:${correct?"#4ade80":"#ff6b6b"};margin-bottom:4px">
        ${correct?"Caught!":"Escaped!"}
      </p>
      <p style="font-size:13px;color:#d4c4f0;margin-bottom:12px">
        ${correct
          ? `${sipahi.emoji} ${sipahi.name} correctly identified ${chor.emoji} ${chor.name} as the Chor!`
          : `${sipahi.emoji} ${sipahi.name} accused ${guessed.emoji} ${guessed.name}, but ${chor.emoji} ${chor.name} was the real Chor!`
        }
      </p>

      <!-- All roles revealed -->
      <div class="players-row" style="margin-bottom:12px">
        ${S.players.map((p,i)=>{
          const role = p.role;
          return `<div style="text-align:center" class="anim-flipIn" style="animation-delay:${i*.1}s">
            <div style="font-size:16px;margin-bottom:4px">${p.emoji} ${p.name}</div>
            <div class="role-card ${role.id}" style="width:70px;height:100px">
              <div class="role-emoji">${role.emoji}</div>
              <div class="role-name">${role.name}</div>
              <div class="role-tamil">${role.tamil}</div>
            </div>
            <div style="font-size:13px;font-weight:800;color:${S.roundScores[i]>0?"#ffd700":"#ff6b6b"};margin-top:4px">
              ${S.roundScores[i]>0?"+"+S.roundScores[i]:"0"}
            </div>
          </div>`;
        }).join("")}
      </div>
    </div>

    ${S.round < TOTAL_ROUNDS
      ? `<button class="btn-primary" style="margin-top:8px" onclick="nextRound()">
          Next Round â†’
        </button>`
      : `<div class="anim-pulse" style="color:#ffd700;font-size:14px;margin-top:8px">Tallying final scores...</div>`
    }
  </div>`;
  return h;
}

function renderGameOver(){
  const ranked = S.players.map((p,i)=>({...p,idx:i})).sort((a,b)=>b.score-a.score);
  const winner = ranked[0];
  const isAI = S.gameMode === "ai";

  let h = `<div class="screen" style="padding-top:16px">
    <div style="font-size:48px;animation:bounceIn .5s ease">ğŸ†</div>
    <div class="title" style="font-size:24px">${isAI && winner.isHuman ? "You Win!" : `${winner.emoji} ${winner.name} Wins!`}</div>
    <div class="subtitle" style="margin-bottom:8px">${TOTAL_ROUNDS} rounds completed</div>

    <!-- Final Scoreboard -->
    <div class="scoreboard">
      ${ranked.map((p,i)=>`
        <div class="score-row ${i===0?"leader":""}">
          <div class="score-rank" style="color:${i===0?"#ffd700":i===1?"#c0c0c0":i===2?"#cd7f32":"#888"}">
            ${i===0?"ğŸ‘‘":i===1?"ğŸ¥ˆ":i===2?"ğŸ¥‰":"4"}
          </div>
          <div style="font-size:18px">${p.emoji}</div>
          <div class="score-name">${p.name}${isAI && p.isHuman?" (You)":""}</div>
          <div class="score-pts">${p.score}</div>
        </div>
      `).join("")}
    </div>

    <!-- Actions -->
    <div style="display:flex;gap:8px;margin-top:16px;flex-wrap:wrap;justify-content:center">
      <button class="btn-primary" onclick="S.screen='game';S.round=0;S.players.forEach(p=>p.score=0);nextRound()">Play Again</button>
      <button class="btn" onclick="resetGame();render()">â† Menu</button>
    </div>

    <!-- Share -->
    <div style="display:flex;gap:8px;margin-top:8px;width:100%;max-width:300px">
      <button class="btn-wa" style="padding:10px;font-size:12px" onclick="shareWA()">ğŸ’¬ Challenge Friends</button>
    </div>
  </div>`;

  app.innerHTML = h;
}

/* â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â• */
(function(){
  const params = new URLSearchParams(window.location.search);
  const roomCode = params.get("room");
  if(roomCode && roomCode.length === 4){
    S.joinCode = roomCode.toUpperCase();
    S.screen = "online";
    render();
    setTimeout(()=>joinRoom(roomCode), 500);
    window.history.replaceState({}, "", window.location.pathname);
    return;
  }
  render();
})();
</script>
</body>
</html>
