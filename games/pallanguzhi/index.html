<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="theme-color" content="#2c1810">
<title>Pallanguzhi ‚Äî J4F</title>
<link rel="manifest" href="/manifest.json">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{font-family:Georgia,serif;background:linear-gradient(180deg,#2c1810,#1a0e08);color:#c4a878;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
#app{height:100dvh;overflow-y:auto;overflow-x:hidden;display:flex;flex-direction:column;align-items:center;padding:12px 10px 100px}

/* Shared */
.title{color:#daa520;font-size:28px;font-weight:700;letter-spacing:3px;text-shadow:0 2px 8px rgba(218,165,32,.3)}
.subtitle{color:#a08060;font-size:12px;letter-spacing:2px}
.btn{padding:8px 14px;background:rgba(60,30,5,.6);color:#c4a878;border:1px solid #6b4530;border-radius:10px;font:600 11px Georgia,serif;cursor:pointer;-webkit-tap-highlight-color:transparent}
.btn-primary{padding:9px 18px;background:linear-gradient(135deg,#b8860b,#8b6508);color:#fff;border:none;border-radius:10px;font:700 13px Georgia,serif;cursor:pointer;box-shadow:0 4px 12px rgba(184,134,11,.4)}
.btn-wa{padding:12px 20px;background:linear-gradient(135deg,#1a5c2e,#0f3d1e);color:#4ade80;border:2px solid #2a8c4a;border-radius:12px;font:700 14px Georgia,serif;cursor:pointer;display:flex;align-items:center;gap:8px;justify-content:center;width:100%}
.btn-copy{padding:12px 20px;background:linear-gradient(135deg,#2a1a4a,#1a0e30);color:#b39ddb;border:2px solid #6b45a0;border-radius:12px;font:700 14px Georgia,serif;cursor:pointer;display:flex;align-items:center;gap:8px;justify-content:center;width:100%}
.card{background:linear-gradient(145deg,#5a3520,#4a2818);border:2px solid #6b4530;border-radius:14px;padding:12px 14px;display:flex;align-items:center;gap:12px;cursor:pointer;text-align:left;width:100%}
.error-box{color:#ff6b6b;font-size:12px;font-weight:600;background:rgba(255,50,50,.15);padding:8px 14px;border-radius:8px;border:1px solid rgba(255,50,50,.3);text-align:center;width:100%}
.hidden{display:none!important}

/* Screens */
.screen{width:100%;max-width:380px;display:flex;flex-direction:column;align-items:center;gap:10px}

/* Board */
.board{background:linear-gradient(145deg,#6b4226,#5a3520,#4a2818);border-radius:18px;padding:12px 7px;box-shadow:0 6px 24px rgba(0,0,0,.5),inset 0 1px 0 rgba(255,255,255,.05),0 0 0 3px #3a1f10,0 0 0 5px #2a1508;width:100%;max-width:380px;position:relative}
.board-row{display:flex;gap:4px}
.board-divider{height:2px;background:linear-gradient(90deg,transparent,#8b6540 20%,#a07848 50%,#8b6540 80%,transparent);margin:5px 0;border-radius:1px}
.row-label{text-align:center;font-size:10px;letter-spacing:1px;margin:4px 0}
.pit-wrap{flex:1;position:relative}
.pit{width:100%;aspect-ratio:1;border-radius:12px;border:2px solid #8b734a;background:radial-gradient(ellipse at 50% 40%,#e8d5b5,#c4a882);display:flex;align-items:center;justify-content:center;cursor:default;box-shadow:inset 0 -3px 6px rgba(0,0,0,.2);transition:all .12s ease;padding:0;outline:none;font-size:0}
.pit.can-click{border-color:#b8860b;background:radial-gradient(ellipse at 50% 40%,#f5e6c8,#d4b896);cursor:pointer}
.pit.active-drop{border-color:#daa520;background:radial-gradient(ellipse at 50% 40%,#f8ecd0,#e0c8a0);transform:scale(1.06);box-shadow:inset 0 -2px 4px rgba(0,0,0,.15),0 0 10px rgba(218,165,32,.4)}
.pit.active-cap{border-color:#ff4444;background:radial-gradient(ellipse at 50% 40%,#ffe0c0,#f0c8a0);box-shadow:inset 0 -2px 4px rgba(0,0,0,.1),0 0 14px rgba(255,68,68,.3)}
.pit.dim{opacity:.6;transform:scale(.97)}
.hand-emoji{position:absolute;top:-20px;left:50%;transform:translateX(-50%);font-size:20px;z-index:20;pointer-events:none;filter:drop-shadow(0 2px 4px rgba(0,0,0,.5))}
.cap-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:9px;color:#ff4444;font-weight:800;pointer-events:none;text-shadow:0 0 6px rgba(255,68,68,.6);animation:capPop .4s ease}

/* Seeds */
.seeds{display:flex;flex-wrap:wrap;justify-content:center;align-items:center;gap:1.5px;padding:1px;max-width:40px}
.seed-dot{width:7px;height:7px;border-radius:50%;display:inline-block}
.seed-count{color:#3e1f05;font-weight:800;font-size:10px;text-align:center}
.seed-empty{opacity:.3;color:#a08060;font-size:12px}

/* Score badges */
.score-bar{display:flex;justify-content:space-between;align-items:center;width:100%;max-width:380px;margin-bottom:6px}
.score-badge{padding:5px 10px;border-radius:8px;font:700 12px Georgia,serif;border:2px solid transparent;transition:all .3s ease}
.score-badge.on{background:linear-gradient(135deg,#b8860b,#8b6508);color:#fff;border-color:#daa520;box-shadow:0 0 10px rgba(218,165,32,.3)}
.score-badge.off{background:rgba(60,30,5,.6);color:#c4a878}

/* Timer */
.timer-ring{position:relative;width:44px;height:44px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.timer-ring svg{position:absolute;transform:rotate(-90deg)}
.timer-num{font-weight:800;font-family:Georgia,serif;z-index:1}

/* Status */
.status-bar{display:flex;align-items:center;justify-content:center;gap:6px;min-height:22px;margin-bottom:4px}
.holding-badge{background:rgba(218,165,32,.15);border:1px solid #daa52044;border-radius:8px;padding:3px 10px;display:flex;align-items:center;gap:5px;color:#daa520;font-size:11px}
.turn-text{font-size:12px;text-align:center}
.seed-counter{color:#705838;font-size:9px;letter-spacing:1px;margin-top:6px}

/* Online lobby */
.room-code-display{background:rgba(0,0,0,.4);border:3px solid #daa520;border-radius:16px;padding:24px 36px;text-align:center}
.room-code-text{color:#daa520;font-size:48px;font-weight:800;letter-spacing:12px;text-shadow:0 2px 12px rgba(218,165,32,.4)}
.join-input{width:100%;max-width:160px;padding:12px;font:800 24px Georgia,serif;text-align:center;letter-spacing:8px;background:rgba(0,0,0,.3);color:#daa520;border:2px solid #6b4530;border-radius:10px;outline:none;text-transform:uppercase}
.share-row{display:flex;gap:8px;width:100%;max-width:320px}

/* Rules */
.rules-box{margin-top:10px;background:rgba(40,20,8,.9);border:1px solid #6b4530;border-radius:12px;padding:12px 14px;max-width:380px;width:100%;font-size:12px;line-height:1.5}

/* Animations */
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes capPop{0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.2)}100%{opacity:0;transform:translate(-50%,-70%) scale(.8)}}
@keyframes pulse{0%,100%{opacity:.6}50%{opacity:1}}
@keyframes dotBlink{0%,20%{opacity:0}50%{opacity:1}100%{opacity:0}}
@keyframes timerPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
@keyframes handDrop{0%{transform:translateX(-50%) translateY(-8px)}100%{transform:translateX(-50%) translateY(0)}}
@keyframes handBounce{0%{transform:translateX(-50%) translateY(0) scale(1)}40%{transform:translateX(-50%) translateY(-12px) scale(1.2)}100%{transform:translateX(-50%) translateY(0) scale(1)}}
@keyframes handGrab{0%{transform:translateX(-50%) scale(1)}50%{transform:translateX(-50%) scale(1.4)}100%{transform:translateX(-50%) scale(1)}}
@keyframes floatY{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
@keyframes popIn{0%{opacity:0;transform:scale(.7)}100%{opacity:1;transform:scale(1)}}
@keyframes spinSlow{from{transform:rotate(0)}to{transform:rotate(360deg)}}
.anim-fadeUp{animation:fadeUp .4s ease both}
.anim-pulse{animation:pulse 1.5s ease infinite}
.anim-float{animation:floatY 2.2s ease-in-out infinite}
.anim-pop{animation:popIn .4s ease both}
.anim-spin{display:inline-block;animation:spinSlow 3.5s linear infinite}
</style>
</head>
<body>
<div id="app"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
<script src="/js/firebase-config.js"></script>
<script src="/js/j4f-sdk.js"></script>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const SEEDS = [
  {id:"cowrie",name:"Cowrie Shells",tamil:"‡Æï‡Æµ‡ØÅ‡Æ∞‡Æø ‡Æö‡Æø‡Æ™‡Øç‡Æ™‡Æø",emoji:"üêö",colors:["#F5F0E8","#EDE4D4","#FFF8EE","#E8DCC8"],stroke:"#C4B49A",snd:{f:2800,d:.08,g:.25}},
  {id:"tamarind",name:"Tamarind Seeds",tamil:"‡Æ™‡ØÅ‡Æ≥‡Æø ‡Æµ‡Æø‡Æ§‡Øà",emoji:"üå∞",colors:["#5C3317","#6B3A1F","#4A2812","#7A4428"],stroke:"#3E1F0A",snd:{f:180,d:.12,g:.35}},
  {id:"neem",name:"Neem Seeds",tamil:"‡Æµ‡Øá‡Æ™‡Øç‡Æ™ ‡Æµ‡Æø‡Æ§‡Øà",emoji:"ü´í",colors:["#6B8E23","#7A9A2E","#556B2F","#8AAA3A"],stroke:"#3A4F15",snd:{f:1200,d:.06,g:.2}},
  {id:"redbeans",name:"Manjadi Seeds",tamil:"‡ÆÆ‡Æû‡Øç‡Æö‡Ææ‡Æü‡Æø",emoji:"üî¥",colors:["#B22222","#CC3333","#8B1A1A","#D94444"],stroke:"#6B0F0F",snd:{f:600,d:.1,g:.18}},
  {id:"pebbles",name:"River Pebbles",tamil:"‡ÆÜ‡Æ±‡Øç‡Æ±‡ØÅ‡Æï‡Øç ‡Æï‡Æ≤‡Øç",emoji:"ü™®",colors:["#808080","#696969","#A9A9A9","#778899"],stroke:"#4A4A4A",snd:{f:3200,d:.05,g:.3}},
  {id:"marbles",name:"Glass Marbles",tamil:"‡Æï‡Øã‡Æ≤‡Æø ‡Æï‡ØÅ‡Æ£‡Øç‡Æü‡ØÅ",emoji:"üîÆ",colors:["#4169E1","#32CD32","#FF6347","#FFD700"],stroke:"#FFFFFF55",snd:{f:4200,d:.15,g:.2}},
];
const TURN_TIME=10, PITS=14, SPP=6, TOTAL=PITS*SPP;
const initBoard=()=>Array(PITS).fill(SPP);
const next=p=>(p+1)%PITS;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const S={
  screen:"select", seedType:null, gameMode:null, aiDiff:"medium",
  board:initBoard(), scores:[0,0], cp:0, gameOver:false, winner:null,
  anim:false, activePit:null, handPit:null, handAct:null, holding:0, capPit:null,
  timeLeft:TURN_TIME, timedOut:false, aiThink:false,
  // online
  roomCode:"", joinCode:"", myPlayer:0, isOnline:false, opJoined:false, onlineErr:"",
  pendingMoves:[], turnId:0, animDone:{p0:true,p1:true}, officialTurnId:0,
  rematchRequestedBy:null, rematchDeadline:null, rematchAcceptedBy:[],
  showRules:false, inviteMsg:"",
  // matchmaking
  searching:false, searchMsg:"", matchmakeStatus:null,
};
let ac=null, timerIv=null, autoTo=null, rematchIv=null, seenMoveId=0, lastAppliedRemoteMoveId=0, cancelMatchmake=null;
const MATCH_RETRY_MAX=2;

function sameArr(a,b){return Array.isArray(a)&&Array.isArray(b)&&a.length===b.length&&a.every((v,i)=>v===b[i])}

function canAdvanceOnlineTurn(){
  return S.isOnline&&!S.anim&&!S.gameOver&&S.animDone.p0&&S.animDone.p1&&S.officialTurnId===S.turnId;
}

function syncOnlineTurnState(st={}){
  if(typeof st.turnId==="number")S.turnId=st.turnId;
  if(st.animDone)S.animDone={p0:!!st.animDone.p0,p1:!!st.animDone.p1};
  if(typeof st.turnId==="number"&&Array.isArray(st.board)&&Array.isArray(st.scores)&&typeof st.cp==="number"){
    if(S.turnId===st.turnId&&!S.anim){
      if(!sameArr(S.board,st.board)||!sameArr(S.scores,st.scores)||S.cp!==st.cp||S.gameOver!==!!st.gameOver||S.winner!==st.winner){
        S.board=st.board.slice();S.scores=st.scores.slice();S.cp=st.cp;S.gameOver=!!st.gameOver;S.winner=st.winner??null;
        if(S.gameOver)S.screen="result";
      }
      S.officialTurnId=st.turnId;
    }
  }
  if(S.screen==="result"&&!S.gameOver)S.screen="game";
  S.rematchRequestedBy=Number.isInteger(st.rematchRequestedBy)?st.rematchRequestedBy:null;
  S.rematchDeadline=typeof st.rematchDeadline==="number"?st.rematchDeadline:null;
  S.rematchAcceptedBy=Array.isArray(st.rematchAcceptedBy)?st.rematchAcceptedBy.filter(v=>v===0||v===1):[];
  maybeStartRematchCountdown();
  maybeStartOnlineRematch();
  if(canAdvanceOnlineTurn()&&S.cp===S.myPlayer&&!timerIv)startTimer();
}

function clearRematchState(){
  S.rematchRequestedBy=null;S.rematchDeadline=null;S.rematchAcceptedBy=[];
  if(rematchIv){clearInterval(rematchIv);rematchIv=null}
}

function rematchSecondsLeft(){
  if(!S.rematchDeadline)return 0;
  return Math.max(0,Math.ceil((S.rematchDeadline-Date.now())/1000));
}

function maybeStartRematchCountdown(){
  if(!S.isOnline||S.screen!=="result"||!S.rematchDeadline){if(rematchIv){clearInterval(rematchIv);rematchIv=null}return}
  if(rematchIv)return;
  rematchIv=setInterval(()=>{
    if(!S.rematchDeadline){clearInterval(rematchIv);rematchIv=null;return}
    if(rematchSecondsLeft()<=0){
      clearInterval(rematchIv);rematchIv=null;
      onRematchExpired();
      return;
    }
    render();
  },250);
}

function onRematchExpired(){
  if(!S.isOnline||!S.gameOver)return;
  const bothAccepted=S.rematchAcceptedBy.includes(0)&&S.rematchAcceptedBy.includes(1);
  if(bothAccepted)return;
  clearRematchState();
  resetGame();
  S.screen="online";
  S.onlineErr="Rematch timed out. Start or join a new room.";
  render();
}

function maybeStartOnlineRematch(){
  if(!S.isOnline||!S.gameOver||!S.rematchDeadline)return;
  if(Date.now()>S.rematchDeadline)return;
  const bothAccepted=S.rematchAcceptedBy.includes(0)&&S.rematchAcceptedBy.includes(1);
  if(!bothAccepted||S.myPlayer!==0)return;
  const nextTurn=S.turnId+1;
  const nextState={
    board:initBoard(),scores:[0,0],cp:0,gameOver:false,winner:null,
    turnId:nextTurn,animDone:{p0:true,p1:true},
    rematchRequestedBy:null,rematchDeadline:null,rematchAcceptedBy:[],
  };
  J4F.room.updateState(nextState).catch(()=>{});
}

function startOnlineRematchRequest(){
  if(!S.isOnline||!S.gameOver)return;
  const deadline=Date.now()+10000;
  const accepted=[S.myPlayer];
  S.rematchRequestedBy=S.myPlayer;S.rematchDeadline=deadline;S.rematchAcceptedBy=accepted.slice();
  maybeStartRematchCountdown();render();
  J4F.room.updateState({rematchRequestedBy:S.myPlayer,rematchDeadline:deadline,rematchAcceptedBy:accepted}).catch(()=>{});
}

function acceptOnlineRematch(){
  if(!S.isOnline||!S.gameOver||!S.rematchDeadline||Date.now()>S.rematchDeadline)return;
  if(S.rematchAcceptedBy.includes(S.myPlayer))return;
  S.rematchAcceptedBy=[...S.rematchAcceptedBy,S.myPlayer].sort();
  render();
  J4F.room.updateState({rematchAcceptedBy:S.rematchAcceptedBy}).catch(()=>{});
  maybeStartOnlineRematch();
}

function markAnimDoneForTurn(turnId){
  if(!S.isOnline||turnId!==S.turnId)return;
  const me=S.myPlayer===0?"p0":"p1";
  if(S.animDone[me])return;
  S.animDone[me]=true;
  J4F.room.updateState({turnId,animDone:{p0:S.animDone.p0,p1:S.animDone.p1}}).catch(()=>{});
}

function ea(){if(!ac)ac=new(window.AudioContext||window.webkitAudioContext)();if(ac.state==="suspended")ac.resume();return ac;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUDIO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function playDrop(st,ps){const a=ea(),s=st.snd,n=a.currentTime,pm=1+(ps%5)*.04;const o=a.createOscillator(),g=a.createGain();o.type="sine";o.frequency.setValueAtTime(s.f*pm,n);o.frequency.exponentialRampToValueAtTime(s.f*.5,n+s.d);g.gain.setValueAtTime(s.g,n);g.gain.exponentialRampToValueAtTime(.001,n+s.d+.05);o.connect(g);g.connect(a.destination);o.start(n);o.stop(n+s.d+.06)}
function playCapture(){const a=ea(),n=a.currentTime;[0,.06,.12].forEach((d,i)=>{const o=a.createOscillator(),g=a.createGain();o.type="sine";o.frequency.value=500+i*200;g.gain.setValueAtTime(.15,n+d);g.gain.exponentialRampToValueAtTime(.001,n+d+.12);o.connect(g);g.connect(a.destination);o.start(n+d);o.stop(n+d+.15)})}
function playPickup(){const a=ea(),n=a.currentTime,bs=a.sampleRate*.08,buf=a.createBuffer(1,bs,a.sampleRate),d=buf.getChannelData(0);for(let i=0;i<bs;i++)d[i]=(Math.random()*2-1)*.15*Math.exp(-i/(bs*.3));const ns=a.createBufferSource(),g=a.createGain();ns.buffer=buf;g.gain.setValueAtTime(.2,n);g.gain.exponentialRampToValueAtTime(.001,n+.08);ns.connect(g);g.connect(a.destination);ns.start(n)}
function playTick(){const a=ea(),n=a.currentTime;const o=a.createOscillator(),g=a.createGain();o.type="sine";o.frequency.value=1000;g.gain.setValueAtTime(.08,n);g.gain.exponentialRampToValueAtTime(.001,n+.04);o.connect(g);g.connect(a.destination);o.start(n);o.stop(n+.05)}
function playTimeout(){const a=ea(),n=a.currentTime;[0,.1].forEach(d=>{const o=a.createOscillator(),g=a.createGain();o.type="square";o.frequency.value=300;g.gain.setValueAtTime(.12,n+d);g.gain.exponentialRampToValueAtTime(.001,n+d+.1);o.connect(g);g.connect(a.destination);o.start(n+d);o.stop(n+d+.12)})}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAME LOGIC ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function compSteps(bIn,pit){const steps=[],b=bIn.slice();let seeds=b[pit];b[pit]=0;steps.push({t:"pickup",p:pit,b:b.slice(),s:seeds});let pos=pit,sf=0;while(sf++<500){for(let i=0;i<seeds;i++){pos=next(pos);b[pos]++;steps.push({t:"drop",p:pos,b:b.slice(),sl:seeds-i-1,sp:b[pos]})}seeds=0;const np=next(pos);if(b[np]>0){seeds=b[np];b[np]=0;steps.push({t:"pickup",p:np,b:b.slice(),s:seeds});pos=np}else{const cp2=next(np);if(b[cp2]>0){const c=b[cp2];b[cp2]=0;steps.push({t:"capture",p:cp2,b:b.slice(),c})}break}}return steps}

function simMove(bIn,pit){const b=bIn.slice();let seeds=b[pit];b[pit]=0;let pos=pit,cap=0,sf=0;while(sf++<500){for(let i=0;i<seeds;i++){pos=next(pos);b[pos]++}seeds=0;const np=next(pos);if(b[np]>0){seeds=b[np];b[np]=0;pos=np}else{const cp2=next(np);if(b[cp2]>0){cap=b[cp2];b[cp2]=0}break}}return{board:b,captured:cap}}

function aiPick(board,diff){const valid=[];for(let i=7;i<14;i++)if(board[i]>0)valid.push(i);if(!valid.length)return-1;if(diff==="easy"&&Math.random()<.7)return valid[Math.floor(Math.random()*valid.length)];if(diff==="medium"&&Math.random()<.35)return valid[Math.floor(Math.random()*valid.length)];let best=valid[0],bestS=-Infinity;for(const p of valid){const r=simMove(board,p);const sc=r.captured*3+r.board.slice(7).reduce((a,b)=>a+b,0)-r.board.slice(0,7).reduce((a,b)=>a+b,0);if(sc>bestS){bestS=sc;best=p}}return best}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TIMER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function startTimer(){
  stopTimer(); S.timeLeft=TURN_TIME; S.timedOut=false;
  let t=TURN_TIME;
  timerIv=setInterval(()=>{
    t--; S.timeLeft=t; if(t<=3&&t>0)playTick();
    if(t<=0){stopTimer();S.timedOut=true;playTimeout();autoTo=setTimeout(autoMove,600)}
    render();
  },1000);
}
function stopTimer(){if(timerIv){clearInterval(timerIv);timerIv=null}if(autoTo){clearTimeout(autoTo);autoTo=null}}
function autoMove(){
  if(S.anim||S.gameOver)return;
  const s=S.cp===0?0:7,e=S.cp===0?7:14,v=[];
  for(let i=s;i<e;i++)if(S.board[i]>0)v.push(i);
  if(v.length>0)doMove(v[Math.floor(Math.random()*v.length)]);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MOVE ENGINE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function doMove(pit,meta={}){
  if(S.anim)return;
  const mover=meta.mover??S.cp;
  const turnId=meta.turnId??(S.turnId+1);
  const isLocalOnlineTurn=S.isOnline&&mover===S.myPlayer&&!meta.remote;

  if(S.isOnline){
    S.turnId=turnId;
    S.animDone={p0:false,p1:false};
    if(isLocalOnlineTurn){
      J4F.room.sendMove({pit,mover,turnId}).catch(()=>{});
      J4F.room.updateState({turnId,animDone:{p0:false,p1:false}}).catch(()=>{});
    }
  }

  S.anim=true; stopTimer(); ea();
  const steps=compSteps(S.board,pit);

  for(const st of steps){
    if(st.t==="pickup"){S.handPit=st.p;S.handAct="pickup";S.holding=st.s;playPickup();S.board=st.b.slice();render();await delay(220)}
    else if(st.t==="drop"){S.handPit=st.p;S.handAct="drop";S.holding=st.sl;S.activePit=st.p;playDrop(S.seedType,st.sp);S.board=st.b.slice();render();await delay(120);S.activePit=null}
    else if(st.t==="capture"){S.handPit=st.p;S.handAct="capture";S.capPit=st.p;playCapture();S.scores[mover]+=st.c;S.board=st.b.slice();render();await delay(380);S.capPit=null}
  }
  S.handPit=null;S.handAct=null;S.holding=0;

  let p1e=true,p2e=true;
  for(let j=0;j<7;j++)if(S.board[j]>0)p1e=false;
  for(let j=7;j<14;j++)if(S.board[j]>0)p2e=false;

  if(p1e||p2e){
    for(let k=0;k<7;k++){S.scores[0]+=S.board[k];S.board[k]=0}
    for(let k=7;k<14;k++){S.scores[1]+=S.board[k];S.board[k]=0}
    S.gameOver=true;S.winner=S.scores[0]>S.scores[1]?0:S.scores[1]>S.scores[0]?1:-1;
    S.screen="result";
    clearRematchState();
    stopTimer();
    // Submit to leaderboard
    if(S.isOnline){
      const r=S.winner===S.myPlayer?"win":S.winner===-1?"draw":"loss";
      J4F.leaderboard.submit("pallanguzhi",r).catch(()=>{});
      J4F.room.finish(S.winner).catch(()=>{});
    } else if(S.gameMode==="ai"){
      const r=S.winner===0?"win":S.winner===-1?"draw":"loss";
      J4F.leaderboard.submit("pallanguzhi",r).catch(()=>{});
    }
  } else {
    const nx=1-mover;
    const npArr=nx===0?S.board.slice(0,7):S.board.slice(7);
    if(npArr.some(v=>v>0))S.cp=nx;
  }
  S.anim=false;

  if(S.isOnline){
    if(isLocalOnlineTurn){
      J4F.room.updateState({
        board:S.board,
        scores:S.scores,
        cp:S.cp,
        gameOver:S.gameOver,
        winner:S.winner,
        turnId,
        rematchRequestedBy:null,
        rematchDeadline:null,
        rematchAcceptedBy:[],
      }).catch(()=>{});
      S.officialTurnId=turnId;
    }
    markAnimDoneForTurn(turnId);
  }

  if(drainPendingRemoteMoves())return;

  render();

  // Trigger AI or timer
  if(!S.gameOver){
    if(S.gameMode==="ai"&&S.cp===1){scheduleAI()}
    else if(S.isOnline&&S.cp!==S.myPlayer){/* wait for opponent */}
    else if(!S.isOnline||canAdvanceOnlineTurn()){startTimer()}
  }
}

function enqueueRemoteMove(moveId,mv){
  if(!mv||mv.mover===S.myPlayer||moveId<=lastAppliedRemoteMoveId)return;
  if(S.pendingMoves.some(pm=>pm.moveId===moveId))return;
  S.pendingMoves.push({moveId,pit:mv.pit,mover:mv.mover,turnId:mv.turnId});
  S.pendingMoves.sort((a,b)=>a.moveId-b.moveId);
}

function drainPendingRemoteMoves(){
  if(S.anim||S.gameOver)return false;
  while(S.pendingMoves.length){
    const mv=S.pendingMoves[0];
    if(mv.moveId<=lastAppliedRemoteMoveId){S.pendingMoves.shift();continue}
    if(mv.mover===S.myPlayer){S.pendingMoves.shift();continue}
    S.pendingMoves.shift();
    lastAppliedRemoteMoveId=mv.moveId;
    doMove(mv.pit,{mover:mv.mover,turnId:mv.turnId,remote:true});
    return true;
  }
  return false;
}

function scheduleAI(){
  S.aiThink=true;render();
  setTimeout(()=>{S.aiThink=false;const p=aiPick(S.board,S.aiDiff);if(p>=0)doMove(p)},800+Math.random()*600);
}

function handlePit(pit){
  if(S.anim||S.gameOver)return;
  if(S.cp===0&&pit>6)return;
  if(S.cp===1&&pit<7)return;
  if(S.board[pit]===0)return;
  if(S.gameMode==="ai"&&S.cp===1)return;
  if(S.isOnline&&S.cp!==S.myPlayer)return;
  ea(); doMove(pit);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ONLINE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// Create room (used by Send to Friends)
async function createRoom(){
  S.onlineErr="";
  try{
    const{code}=await J4F.room.create("pallanguzhi",{board:initBoard(),scores:[0,0],cp:0,gameOver:false,winner:null,turnId:0,animDone:{p0:true,p1:true},rematchRequestedBy:null,rematchDeadline:null,rematchAcceptedBy:[]});
    S.roomCode=code;S.myPlayer=0;S.isOnline=true;S.opJoined=false;
    S.board=initBoard();S.scores=[0,0];S.cp=0;S.gameOver=false;S.winner=null;S.pendingMoves=[];S.turnId=0;S.animDone={p0:true,p1:true};S.officialTurnId=0;seenMoveId=0;lastAppliedRemoteMoveId=0;
    S.screen="lobby";render();
    setupHostListener();
  }catch(e){S.onlineErr="Failed: "+(e.message||e);render()}
}

// Send to Friends ‚Äî auto-create room, go to lobby with share options
async function sendToFriends(){
  await createRoom();
}

// Join a room by code
async function joinRoom(codeOverride){
  S.onlineErr="";
  const code=(codeOverride||S.joinCode).toUpperCase().trim();
  if(code.length!==4){S.onlineErr="Enter a 4-letter code";render();return}
  try{
    const{roomData}=await J4F.room.join(code);
    S.roomCode=code;S.myPlayer=1;S.isOnline=true;S.opJoined=true;
    const st=roomData.state||{};
    S.board=st.board||initBoard();S.scores=st.scores||[0,0];S.cp=st.cp||0;
    S.gameOver=false;S.winner=null;S.pendingMoves=[];S.turnId=st.turnId||0;S.animDone=st.animDone||{p0:true,p1:true};S.officialTurnId=S.turnId;seenMoveId=0;lastAppliedRemoteMoveId=0;
    S.gameMode="online";S.screen="game";render();
    setupGuestListener();
    if(S.cp===S.myPlayer)startTimer();
  }catch(e){S.onlineErr=e.message||"Failed to join";render()}
}

// Search Online ‚Äî matchmaking
function searchOnline(){
  startMatchmakeAttempt(1);
}

function startMatchmakeAttempt(attempt){
  S.searching=true;S.matchmakeStatus=null;S.onlineErr="";
  S.searchMsg=`Looking for players... (attempt ${attempt}/${MATCH_RETRY_MAX+1})`;render();
  cancelMatchmake=J4F.room.matchmake(
    "pallanguzhi",
    {board:initBoard(),scores:[0,0],cp:0,gameOver:false,winner:null,turnId:0,animDone:{p0:true,p1:true},rematchRequestedBy:null,rematchDeadline:null,rematchAcceptedBy:[]},
    (code,player,roomData)=>{
      cancelMatchmake=null;S.searching=false;S.matchmakeStatus=null;
      S.roomCode=code;S.myPlayer=player;S.isOnline=true;
      S.board=initBoard();S.scores=[0,0];S.cp=0;S.gameOver=false;S.winner=null;S.pendingMoves=[];S.turnId=0;S.animDone={p0:true,p1:true};S.officialTurnId=0;seenMoveId=0;lastAppliedRemoteMoveId=0;
      if(player===0){
        S.opJoined=false;S.screen="lobby";render();
        setupHostListener();
      }else{
        const st=roomData?.state||{};
        S.board=st.board||initBoard();S.scores=st.scores||[0,0];S.cp=st.cp||0;S.turnId=st.turnId||0;S.animDone=st.animDone||{p0:true,p1:true};S.officialTurnId=S.turnId;
        S.opJoined=true;S.gameMode="online";S.screen="game";render();
        setupGuestListener();
        if(S.cp===S.myPlayer)startTimer();
      }
    },
    (status)=>{
      cancelMatchmake=null;
      const payload=typeof status==="string"
        ?{status:"matchmake_error",reasonCode:"UNKNOWN",message:status,retryable:false,nextAction:"Use Send to Friends to share an invite code."}
        :status;
      const canRetry=attempt<=MATCH_RETRY_MAX&&payload.retryable!==false;
      if(canRetry){
        S.searchMsg=`${payload.message} Retrying... (${attempt+1}/${MATCH_RETRY_MAX+1})`;
        render();
        setTimeout(()=>startMatchmakeAttempt(attempt+1),700);
        return;
      }
      S.searching=false;
      S.matchmakeStatus={
        ...payload,
        attempt,
        nextAction:payload.nextAction||"Tap Send to Friends, share the code, then ask your friend to join.",
      };
      S.onlineErr=`${payload.message} (${payload.reasonCode})`;render();
    },
    {timeoutMs:30000,maxJoinAttempts:2,maxCreateAttempts:2,staleEntryMs:45000}
  );
}

function cancelSearch(){
  if(cancelMatchmake){cancelMatchmake();cancelMatchmake=null}
  S.searching=false;S.searchMsg="";S.matchmakeStatus=null;render();
}

// Listeners
function setupHostListener(){
  J4F.room.onUpdate(data=>{
    syncOnlineTurnState(data.state||{});
    if(!S.opJoined&&data.guest&&data.status==="playing"){
      S.opJoined=true;S.gameMode="online";S.screen="game";render();startTimer();
      return;
    }
    if(data.moveId>seenMoveId&&data.lastMove){
      seenMoveId=data.moveId;
      enqueueRemoteMove(data.moveId,data.lastMove);
      drainPendingRemoteMoves();
    }
  });
}

function setupGuestListener(){
  J4F.room.onUpdate(data=>{
    syncOnlineTurnState(data.state||{});
    if(data.moveId>seenMoveId&&data.lastMove){
      seenMoveId=data.moveId;
      enqueueRemoteMove(data.moveId,data.lastMove);
      drainPendingRemoteMoves();
    }
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RESET ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function resetGame(){
  stopTimer();J4F.room.leave().catch(()=>{});
  clearRematchState();
  if(cancelMatchmake){cancelMatchmake();cancelMatchmake=null}
  Object.assign(S,{board:initBoard(),scores:[0,0],cp:0,gameOver:false,winner:null,anim:false,activePit:null,handPit:null,handAct:null,holding:0,capPit:null,timeLeft:TURN_TIME,timedOut:false,aiThink:false,isOnline:false,opJoined:false,roomCode:"",joinCode:"",onlineErr:"",inviteMsg:"",searching:false,searchMsg:"",matchmakeStatus:null,pendingMoves:[],rematchRequestedBy:null,rematchDeadline:null,rematchAcceptedBy:[]});
  S.turnId=0;S.animDone={p0:true,p1:true};S.officialTurnId=0;
  seenMoveId=0;lastAppliedRemoteMoveId=0;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SHARE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function shareWA(code){
  const base=window.location.origin+"/games/pallanguzhi/";
  const url=code?base+"?room="+code:base;
  const text=code?"üé≤ Join my Pallanguzhi game on J4F!\n\nTap to play: "+url:"üé≤ Let's play Pallanguzhi on J4F!\n\nPlay here: "+url;
  J4F.share.whatsapp(text);
}
async function shareCopy(code){
  const base=window.location.origin+"/games/pallanguzhi/";
  const url=code?base+"?room="+code:base;
  const text=code?"Join my Pallanguzhi game!\n\nTap to play: "+url:"Let's play Pallanguzhi!\n\nPlay here: "+url;
  const ok=await J4F.share.copy(text);
  S.inviteMsg=ok?"Copied!":"Couldn't copy";render();setTimeout(()=>{S.inviteMsg="";render()},2000);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const delay=ms=>new Promise(r=>setTimeout(r,ms));
const $=id=>document.getElementById(id);
const app=$("app");

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function render(){
  if(S.screen==="select")renderSelect();
  else if(S.screen==="mode")renderMode();
  else if(S.screen==="online")renderOnline();
  else if(S.screen==="searching")renderSearching();
  else if(S.screen==="lobby")renderLobby();
  else if(S.screen==="game")renderGame();
  else if(S.screen==="result")renderResult();
}

function restartLocalMatch(){
  const st=S.seedType,gm=S.gameMode,diff=S.aiDiff;
  resetGame();
  S.seedType=st;S.gameMode=gm;S.aiDiff=diff;S.screen="game";
  render();startTimer();
}

function resultViewData(){
  const isOn=S.gameMode==="online",isAI=S.gameMode==="ai";
  const won=isOn?S.winner===S.myPlayer:isAI?S.winner===0:S.winner===0;
  if(S.winner===-1)return{title:"Draw Game",msg:"Evenly matched!",emoji:"ü§ù",accent:"#5bc0de",anim:"anim-spin"};
  if(won)return{title:"Victory!",msg:"Beautiful captures and perfect timing.",emoji:"üèÜ",accent:"#4ade80",anim:"anim-float"};
  return{title:"Defeat",msg:"A tough round. Ready for revenge?",emoji:"üí•",accent:"#ff8c6b",anim:"anim-pulse"};
}

function renderResult(){
  const isOn=S.gameMode==="online",isAI=S.gameMode==="ai";
  const myScore=isOn?S.scores[S.myPlayer]:S.scores[0],oppScore=isOn?S.scores[1-S.myPlayer]:S.scores[1];
  const r=resultViewData();
  const sec=rematchSecondsLeft();
  const reqByMe=S.rematchRequestedBy===S.myPlayer;
  const requested=S.rematchRequestedBy===0||S.rematchRequestedBy===1;
  const iAccepted=S.rematchAcceptedBy.includes(S.myPlayer);
  const opAccepted=S.rematchAcceptedBy.includes(1-S.myPlayer);

  let onlineActions="";
  if(isOn){
    if(!requested){
      onlineActions=`<button class="btn-primary" onclick="startOnlineRematchRequest()">üîÅ Request Rematch</button>`;
    }else if(sec>0){
      if(!iAccepted)onlineActions=`<button class="btn-primary" onclick="acceptOnlineRematch()">‚úÖ Accept Rematch</button>`;
      else onlineActions=`<button class="btn" disabled style="opacity:.8">Waiting for opponent‚Ä¶</button>`;
    }
    const who=requested?(reqByMe?"You requested":"Opponent requested"):"No rematch request yet";
    onlineActions+=`<div style="width:100%;margin-top:8px;padding:10px;border-radius:10px;background:rgba(30,20,10,.45);border:1px solid #6b4530;text-align:center;color:#c4a878;font-size:12px">${who}${requested?` ¬∑ ‚è≥ ${sec}s ¬∑ ${opAccepted?"Opponent accepted":"Awaiting opponent"}`:""}</div>`;
  }

  app.innerHTML=`<div class="screen" style="padding-top:26px;gap:12px">
    <div class="title" style="font-size:24px">‡Æ™‡Æ≤‡Øç‡Æ≤‡Ææ‡Æô‡Øç‡Æï‡ØÅ‡Æ¥‡Æø</div>
    <div class="anim-pop" style="width:100%;background:linear-gradient(145deg,#5a3520,#3a2114);border:2px solid ${r.accent};border-radius:18px;padding:18px;text-align:center;box-shadow:0 8px 24px rgba(0,0,0,.35)">
      <div class="${r.anim}" style="font-size:56px">${r.emoji}</div>
      <div style="color:${r.accent};font-size:24px;font-weight:700;margin-top:6px">${r.title}</div>
      <div style="color:#b99770;font-size:12px;margin-top:4px">${r.msg}</div>
    </div>
    <div style="width:100%;background:rgba(0,0,0,.28);border:1px solid #6b4530;border-radius:12px;padding:12px;display:flex;justify-content:space-between;font-size:14px">
      <div>You: <strong style="color:#daa520">${myScore}</strong></div>
      <div>${isOn?"Opponent":isAI?"AI":"P2"}: <strong style="color:#daa520">${oppScore}</strong></div>
    </div>
    <div style="display:flex;flex-direction:column;gap:8px;width:100%">
      ${isOn?onlineActions:`<button class="btn-primary" onclick="restartLocalMatch()">üîÅ Play Again</button>`}
      <button class="btn" onclick="resetGame();S.seedType=SEEDS[${SEEDS.indexOf(S.seedType)}];S.screen='mode';render()">Mode</button>
    </div>
  </div>`;
}

function seedDots(st,count,sz=7){
  if(count===0)return'<span class="seed-empty">¬∑</span>';
  const n=Math.min(count,count>12?6:count);
  let h='<div class="seeds">';
  for(let i=0;i<n;i++){const c=st.colors[i%st.colors.length];h+=`<span class="seed-dot" style="width:${sz}px;height:${sz}px;background:${c};border:1px solid ${st.stroke}"></span>`}
  if(count>12)h+=`<span class="seed-count">${count}</span>`;
  h+='</div>';return h;
}

function renderSelect(){
  let h=`<div class="screen" style="padding-top:20px">
    <div class="title">‡Æ™‡Æ≤‡Øç‡Æ≤‡Ææ‡Æô‡Øç‡Æï‡ØÅ‡Æ¥‡Æø</div>
    <div class="subtitle">PALLANGUZHI</div>
    <a href="/" style="color:#4d96ff;font-size:11px;text-decoration:none;margin-bottom:4px">‚Üê J4F Home</a>
    <p style="font-size:13px;margin-bottom:4px">Choose your seeds</p>`;
  SEEDS.forEach((st,i)=>{
    h+=`<div class="card anim-fadeUp" style="animation-delay:${i*.05}s" onclick="S.seedType=SEEDS[${i}];S.screen='mode';render()">
      <div style="width:50px;height:50px;border-radius:12px;background:radial-gradient(ellipse at 50% 40%,#e8d5b5,#c4a882);display:flex;flex-wrap:wrap;justify-content:center;align-items:center;gap:2px;padding:3px;box-shadow:inset 0 -3px 6px rgba(0,0,0,.2);flex-shrink:0">
        ${[0,1,2,3].map(j=>`<span class="seed-dot" style="width:12px;height:12px;background:${st.colors[j]};border:1px solid ${st.stroke}"></span>`).join("")}
      </div>
      <div style="flex:1"><div style="color:#daa520;font-weight:700;font-size:14px">${st.name}</div><div style="color:#a08060;font-size:11px">${st.tamil}</div></div>
      <div style="font-size:26px;flex-shrink:0">${st.emoji}</div>
    </div>`;
  });
  h+='</div>';app.innerHTML=h;
}

function renderMode(){
  const st=S.seedType;
  const diffs=[{id:"easy",l:"Easy",e:"üòä",d:"AI plays mostly random",c:"#4CAF50"},{id:"medium",l:"Medium",e:"üß†",d:"AI thinks before playing",c:"#FF9800"},{id:"hard",l:"Hard",e:"üî•",d:"AI always picks best move",c:"#f44336"}];
  let h=`<div class="screen" style="padding-top:20px">
    <div class="title" style="font-size:24px">‡Æ™‡Æ≤‡Øç‡Æ≤‡Ææ‡Æô‡Øç‡Æï‡ØÅ‡Æ¥‡Æø</div>
    <div class="subtitle">${st.emoji} ${st.name}</div>
    <p style="font-size:15px;font-weight:600;margin:4px 0">Choose Game Mode</p>

    <div class="card" onclick="resetGame();S.seedType=SEEDS[${SEEDS.indexOf(st)}];S.gameMode='pvp';S.screen='game';render();startTimer()">
      <div style="font-size:32px">üë•</div>
      <div style="flex:1"><div style="color:#daa520;font-weight:700;font-size:15px">Local 2 Player</div><div style="color:#a08060;font-size:11px">Same device ¬∑ ‚è±Ô∏è 10 sec turns</div></div>
    </div>

    <div class="card" style="background:linear-gradient(145deg,#1a3a5c,#0f2840);border-color:#2a6a9c" onclick="S.onlineErr='';S.joinCode='';S.screen='online';render()">
      <div style="font-size:32px">üåê</div>
      <div style="flex:1"><div style="color:#5bc0de;font-weight:700;font-size:15px">Online Multiplayer</div><div style="color:#7ab8d4;font-size:11px">Play with a friend remotely</div></div>
    </div>

    <p style="font-size:13px;font-weight:600;margin:8px 0 0">ü§ñ Play vs AI</p>`;
  diffs.forEach(d=>{
    h+=`<div class="card" onclick="resetGame();S.seedType=SEEDS[${SEEDS.indexOf(st)}];S.gameMode='ai';S.aiDiff='${d.id}';S.screen='game';render();startTimer()">
      <div style="font-size:26px">${d.e}</div>
      <div style="flex:1"><div style="color:${d.c};font-weight:700;font-size:14px">${d.l}</div><div style="color:#a08060;font-size:11px">${d.d}</div></div>
      <div style="color:#6b4530;font-size:16px">‚Üí</div>
    </div>`;
  });
  h+=`<button class="btn" style="margin-top:12px" onclick="S.screen='select';render()">‚Üê Change Seeds</button>
    <div style="margin-top:8px;font-size:11px;color:#705838;cursor:pointer" onclick="shareWA()">üì§ Share this game with friends${S.inviteMsg?' <span style="color:#fbbf24">‚úì '+S.inviteMsg+'</span>':""}</div>
  </div>`;
  app.innerHTML=h;
}

function renderOnline(){
  const st=S.seedType;
  let h=`<div class="screen" style="padding-top:20px;justify-content:center">
    <div class="title" style="font-size:24px">‡Æ™‡Æ≤‡Øç‡Æ≤‡Ææ‡Æô‡Øç‡Æï‡ØÅ‡Æ¥‡Æø</div>
    <div class="subtitle">${st.emoji} ${st.name}</div>
    <p style="color:#5bc0de;font-size:15px;font-weight:600;margin:4px 0">üåê Online Play</p>

    <button class="card" style="background:linear-gradient(145deg,#1a3a5c,#0f2840);border-color:#2a6a9c" onclick="S.screen='searching';searchOnline()">
      <div style="font-size:28px">üîç</div>
      <div style="flex:1"><div style="color:#5bc0de;font-weight:700;font-size:15px">Search Online</div><div style="color:#7ab8d4;font-size:11px">Match with a real player</div></div>
    </button>

    <button class="card" style="background:linear-gradient(145deg,#1a4a2a,#0f3018);border-color:#2a8c4a" onclick="sendToFriends()">
      <div style="font-size:28px">üë´</div>
      <div style="flex:1"><div style="color:#4ade80;font-weight:700;font-size:15px">Send to Friends</div><div style="color:#6bcb77;font-size:11px">Create a link to share</div></div>
    </button>

    <div style="color:#6b4530;font-size:11px;letter-spacing:2px;margin:4px 0">‚îÄ‚îÄ HAVE A CODE? ‚îÄ‚îÄ</div>

    <div style="width:100%;background:linear-gradient(135deg,#3a2a1a,#2a1a0a);border:2px solid #6b4530;border-radius:14px;padding:14px;text-align:center;display:flex;align-items:center;gap:10px;justify-content:center">
      <div style="font-size:20px">üéÆ</div>
      <input class="join-input" type="text" maxlength="4" placeholder="ABCD" style="max-width:120px;padding:8px;font-size:20px" value="${S.joinCode}" oninput="S.joinCode=this.value.toUpperCase();S.onlineErr=''">
      <button class="btn-primary" onclick="joinRoom()">Join</button>
    </div>

    ${S.onlineErr?`<div class="error-box">‚ö†Ô∏è ${S.onlineErr}</div>`:""}
    <button class="btn" onclick="S.screen='mode';render()">‚Üê Back</button>
  </div>`;
  app.innerHTML=h;
}

function renderSearching(){
  const hasFail=!!S.matchmakeStatus;
  let h=`<div class="screen" style="padding-top:40px;justify-content:center;align-items:center">
    <div class="title" style="font-size:24px">‡Æ™‡Æ≤‡Øç‡Æ≤‡Ææ‡Æô‡Øç‡Æï‡ØÅ‡Æ¥‡Æø</div>
    <div style="font-size:48px;margin:20px 0">üîç</div>
    <p style="color:#5bc0de;font-size:16px;font-weight:700">${hasFail?"Matchmaking ended":"Searching for opponent"}</p>
    <div class="${hasFail?"":"anim-pulse"}" style="color:#7ab8d4;font-size:14px;margin-top:4px">
      ${S.searchMsg||"Looking for players"}<span style="display:inline-flex;gap:2px">
        <span style="animation:dotBlink 1.4s ease infinite">.</span>
        <span style="animation:dotBlink 1.4s ease infinite .2s">.</span>
        <span style="animation:dotBlink 1.4s ease infinite .4s">.</span>
      </span>
    </div>
    <p style="color:#705838;font-size:11px;margin-top:12px">This may take up to 30 seconds per attempt</p>
    ${hasFail?`<div class="error-box" style="margin-top:10px">‚ö†Ô∏è ${S.matchmakeStatus.message}<br><span style="font-size:11px;opacity:.9">Code: ${S.matchmakeStatus.reasonCode}</span><br><span style="font-size:11px;opacity:.9">Next: ${S.matchmakeStatus.nextAction}</span></div>`:""}
    ${hasFail?`<button class="btn-primary" style="margin-top:12px" onclick="searchOnline()">Retry Search</button>`:""}
    <button class="btn" style="margin-top:12px" onclick="cancelSearch();S.screen='online';render()">${hasFail?"Back":"Cancel"}</button>
    ${hasFail?`<button class="card" style="margin-top:8px;background:linear-gradient(145deg,#1a4a2a,#0f3018);border-color:#2a8c4a" onclick="cancelSearch();S.screen='online';render();sendToFriends()"><div style="font-size:24px">üë´</div><div style="flex:1"><div style="color:#4ade80;font-weight:700;font-size:14px">Send to Friends</div><div style="color:#6bcb77;font-size:11px">Next: Create a room and share the code now</div></div></button>`:""}
  </div>`;
  app.innerHTML=h;
}

function renderLobby(){
  let h=`<div class="screen" style="padding-top:20px;justify-content:center;align-items:center">
    <div class="title" style="font-size:24px">‡Æ™‡Æ≤‡Øç‡Æ≤‡Ææ‡Æô‡Øç‡Æï‡ØÅ‡Æ¥‡Æø</div>
    <p style="color:#5bc0de;font-size:14px;font-weight:600;margin:4px 0">üåê Room Created!</p>

    <div class="room-code-display">
      <div style="color:#a08060;font-size:11px;letter-spacing:2px;margin-bottom:6px">ROOM CODE</div>
      <div class="room-code-text">${S.roomCode}</div>
    </div>

    <div style="color:#c4a878;font-size:13px;margin:6px 0">Share this code with your friend</div>
    <div class="anim-pulse" style="color:#5bc0de;font-size:14px">
      Waiting for opponent<span style="display:inline-flex;gap:2px">
        <span style="animation:dotBlink 1.4s ease infinite">.</span>
        <span style="animation:dotBlink 1.4s ease infinite .2s">.</span>
        <span style="animation:dotBlink 1.4s ease infinite .4s">.</span>
      </span>
    </div>

    <div class="share-row" style="margin-top:12px">
      <button class="btn-wa" style="flex:1;padding:10px;font-size:12px" onclick="shareWA('${S.roomCode}')">üí¨ WhatsApp</button>
      <button class="btn-copy" style="flex:1;padding:10px;font-size:12px" onclick="shareCopy('${S.roomCode}')">üìã Copy${S.inviteMsg?" ‚úì":""}</button>
    </div>

    <button class="btn" style="margin-top:12px" onclick="resetGame();S.screen='mode';render()">Cancel</button>
  </div>`;
  app.innerHTML=h;
}

function renderGame(){
  const st=S.seedType;
  const isAI=S.gameMode==="ai",isOn=S.gameMode==="online";
  const flipped=isOn&&S.myPlayer===1;
  const topRow=flipped?[6,5,4,3,2,1,0]:[13,12,11,10,9,8,7];
  const bottomRow=flipped?[7,8,9,10,11,12,13]:[0,1,2,3,4,5,6];
  const botP=flipped?1:0, topP=flipped?0:1;
  const botLbl=isOn||isAI?"You":"P1", topLbl=isOn?"Opponent":isAI?"AI":"P2";
  const myTurn=isOn?S.cp===S.myPlayer:(isAI?S.cp===0:true);
  const showTimer=!S.anim&&!S.gameOver&&myTurn&&!(isAI&&S.cp===1);

  let turnText="";
  if(S.gameOver){
    if(S.winner===-1)turnText="Draw!";
    else if(isOn)turnText=S.winner===S.myPlayer?"You Win! üéâ":"You Lost üò§";
    else if(isAI)turnText=S.winner===0?"You Win! üéâ":"AI Wins üò§";
    else turnText="P"+(S.winner+1)+" Wins! üéâ";
  }else if(isOn){turnText=S.cp===S.myPlayer?"Your Turn":"Opponent's Turn";}
  else if(isAI){turnText=S.cp===0?"Your Turn":"AI's Turn";}
  else{turnText="P"+(S.cp+1)+"'s Turn";}

  function pitHTML(pit,row){
    const pOwner=pit<7?0:1;
    const canClick=pOwner===S.cp&&S.board[pit]>0&&!S.gameOver&&!S.anim&&!(isAI&&S.cp===1)&&!(isOn&&S.cp!==S.myPlayer);
    const isDrop=S.activePit===pit, isCap=S.capPit===pit, isHand=S.handPit===pit;
    let cls="pit";
    if(canClick)cls+=" can-click"; else if(S.gameOver)cls+=" dim"; else cls+=" dim";
    if(isDrop)cls+=" active-drop"; if(isCap)cls+=" active-cap";
    let extra="";
    if(isHand){
      const anim=S.handAct==="pickup"?"handBounce .25s ease":S.handAct==="capture"?"handGrab .35s ease":"handDrop .12s ease";
      const emoji=S.handAct==="capture"?"‚úä":"ü§è";
      extra+=`<div class="hand-emoji" style="animation:${anim}">${emoji}</div>`;
    }
    if(isCap)extra+=`<div class="cap-text">CAPTURED!</div>`;
    return`<div class="pit-wrap"><button class="${cls}" onclick="handlePit(${pit})">${seedDots(st,S.board[pit])}</button>${extra}</div>`;
  }

  // Timer HTML
  let timerHTML="";
  if(showTimer){
    const r=18,circ=2*Math.PI*r,off=circ*(1-S.timeLeft/TURN_TIME);
    const col=S.timeLeft<=3?"#ff4444":S.timeLeft<=5?"#ff8c00":"#daa520";
    timerHTML=`<div class="timer-ring"><svg width="44" height="44"><circle cx="22" cy="22" r="${r}" fill="none" stroke="rgba(100,70,40,.3)" stroke-width="3.5"/><circle cx="22" cy="22" r="${r}" fill="none" stroke="${col}" stroke-width="3.5" stroke-dasharray="${circ}" stroke-dashoffset="${off}" stroke-linecap="round" style="transition:stroke-dashoffset .3s linear"/></svg><span class="timer-num" style="font-size:${S.timeLeft<=3?18:16}px;color:${col};${S.timeLeft<=3?"animation:timerPulse .5s ease infinite":""}">${S.timeLeft}</span></div>`;
  }else if(S.aiThink){
    timerHTML=`<div style="color:#daa520;font-size:12px" class="anim-pulse">ü§ñ Thinking...</div>`;
  }else if(isOn&&!myTurn&&!S.anim&&!S.gameOver){
    timerHTML=`<div style="color:#5bc0de;font-size:11px" class="anim-pulse">‚è≥ Waiting...</div>`;
  }else if(S.gameOver){
    timerHTML=`<div style="font-size:22px">üèÜ</div>`;
  }else if(S.anim){
    timerHTML=`<div style="font-size:20px">ü§è</div>`;
  }

  let h=`
  <!-- Header -->
  <div style="display:flex;align-items:center;justify-content:space-between;width:100%;max-width:380px;margin-bottom:4px">
    <div>
      <div class="title" style="font-size:20px;letter-spacing:2px">‡Æ™‡Æ≤‡Øç‡Æ≤‡Ææ‡Æô‡Øç‡Æï‡ØÅ‡Æ¥‡Æø</div>
      <div style="color:#a08060;font-size:9px;letter-spacing:1.5px">${st.emoji} ${st.name} ¬∑ ${isOn?"üåê "+S.roomCode:isAI?"AI ("+S.aiDiff+")":"PvP"}</div>
    </div>
    ${timerHTML}
  </div>

  <!-- Status -->
  <div class="status-bar">
    ${S.timedOut?'<span style="color:#ff8c00;font-size:11px;font-weight:700">‚è±Ô∏è Time\'s up!</span>':""}
    ${S.holding>0?`<div class="holding-badge">ü§è <strong>${S.holding}</strong> ${seedDots(st,Math.min(S.holding,4),6)}${S.holding>4?`<span style="font-size:8px">+${S.holding-4}</span>`:""}</div>`:""}
  </div>

  <!-- Scores -->
  <div class="score-bar">
    <div class="score-badge ${S.cp===topP&&!S.gameOver?"on":"off"}">‚ñ≤ ${topLbl}: ${S.scores[topP]}</div>
    <div class="turn-text" style="${S.gameOver?"color:#daa520;font-weight:700":""}">${turnText}</div>
    <div class="score-badge ${S.cp===botP&&!S.gameOver?"on":"off"}">‚ñº ${botLbl}: ${S.scores[botP]}</div>
  </div>

  <!-- Board -->
  <div class="board">
    <div class="row-label" style="color:${S.cp===topP&&!S.gameOver?"#daa520":"#7a6040"}">‚ñ≤ ${topLbl.toUpperCase()} ‚ñ≤</div>
    <div class="board-row">${topRow.map(p=>pitHTML(p,"top")).join("")}</div>
    <div class="board-divider"></div>
    <div class="board-row">${bottomRow.map(p=>pitHTML(p,"bot")).join("")}</div>
    <div class="row-label" style="color:${S.cp===botP&&!S.gameOver?"#daa520":"#7a6040"}">‚ñº ${botLbl.toUpperCase()} ‚ñº</div>
  </div>

  <!-- Seed counter -->
  <div class="seed-counter">In play: ${S.board.reduce((a,b)=>a+b,0)} ¬∑ Captured: ${S.scores[0]+S.scores[1]} ¬∑ Total: ${TOTAL}</div>

  <!-- Buttons -->
  <div style="display:flex;gap:6px;margin-top:10px;flex-wrap:wrap;justify-content:center">
    ${S.gameOver?`<button class="btn-primary" onclick="resetGame();S.seedType=SEEDS[${SEEDS.indexOf(st)}];${isOn?"S.screen='mode'":"S.screen='game';S.gameMode='"+S.gameMode+"';S.aiDiff='"+S.aiDiff+"'"};render();${isOn?"":"startTimer()"}">New Game</button>`:""}
    <button class="btn" onclick="S.showRules=!S.showRules;render()">${S.showRules?"Hide":"Rules"}</button>
    <button class="btn" onclick="resetGame();S.seedType=SEEDS[${SEEDS.indexOf(st)}];S.screen='mode';render()">Mode</button>
    ${!isOn?`<button class="btn" onclick="resetGame();S.screen='select';render()">${st.emoji} Seeds</button>`:""}
    ${!S.gameOver&&!isOn?`<button class="btn" onclick="resetGame();S.seedType=SEEDS[${SEEDS.indexOf(st)}];S.gameMode='${S.gameMode}';S.aiDiff='${S.aiDiff}';S.screen='game';render();startTimer()">Restart</button>`:""}
  </div>

  <!-- Rules -->
  ${S.showRules?`<div class="rules-box">
    <p style="font-weight:700;color:#daa520;margin-bottom:6px">How to Play</p>
    <p style="margin-bottom:5px">Each player owns one row (7 pits). You play the bottom row.</p>
    <p style="margin-bottom:5px">‚è±Ô∏è 10 sec per turn. Time out = random pick!</p>
    ${isOn?`<p style="margin-bottom:5px">üåê Room: ${S.roomCode} ¬∑ Opponent sees your moves live!</p>`:""}
    ${isAI?`<p style="margin-bottom:5px">ü§ñ AI (${S.aiDiff}) plays the top row.</p>`:""}
    <p style="margin-bottom:5px">Sow: Tap a pit, seeds drop one-by-one.</p>
    <p style="margin-bottom:5px">Continue: Next pit has seeds? Pick up and keep going.</p>
    <p style="margin-bottom:5px">Capture: Next pit empty? Take from pit after it.</p>
    <p>Win: Side empty ‚Üí remaining go to owner. Most wins!</p>
  </div>`:""}`;

  app.innerHTML=h;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
// Check for deep-link: ?room=CODE
(function(){
  const params=new URLSearchParams(window.location.search);
  const roomCode=params.get("room");
  if(roomCode&&roomCode.length===4){
    // Default to cowrie seeds for deep-link joins
    S.seedType=SEEDS[0];
    S.joinCode=roomCode.toUpperCase();
    S.screen="online";
    render();
    // Auto-join after a short delay to let Firebase init
    setTimeout(()=>joinRoom(roomCode),500);
    // Clean URL without reloading
    window.history.replaceState({},"",window.location.pathname);
    return;
  }
  render();
})();
</script>
</body>
</html>
